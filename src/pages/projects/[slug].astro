---
/**
 * Project Detail Page
 * Dynamic route for individual project pages
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/common/Header.astro';
import Footer from '../../components/common/Footer.astro';
import { getAllProcessedProjects, getProjectBySlug } from '../../lib/airtable';
import { Image } from 'astro:assets';

// Generate static paths for all projects
export async function getStaticPaths() {
  const projects = await getAllProcessedProjects();

  return projects.map(project => ({
    params: { slug: project.slug },
    props: { project }
  }));
}

const { project } = Astro.props;

if (!project) {
  return Astro.redirect('/404');
}

// Prepare OG image
const ogImage = project.cover?.url || '/og-image.jpg';
---

<BaseLayout
  title={project.seo.title}
  description={project.seo.description}
  keywords={project.seo.keywords}
  ogImage={ogImage}
  canonicalUrl={`${Astro.site}projects/${project.slug}`}
>
  <Header slot="header" />

  <!-- Project Header -->
  <article class="py-12" data-project-id={project.id}>
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumbs -->
      <nav class="mb-8 text-sm text-gray-600">
        <a href="/muestra" class="hover:text-[var(--color-cta)]">Inicio</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">{project.title}</span>
      </nav>

      <!-- Title and Meta -->
      <header class="mb-12">
        <h1 class="text-4xl md:text-5xl font-bold mb-6">
          {project.title}
        </h1>

        <div class="flex flex-wrap items-center gap-4 text-gray-600 mb-6">
          {project.cycle && (
            <span class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              {project.cycle}
            </span>
          )}
          {project.authors.length > 0 && (
            <span class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              {project.authors.length} {project.authors.length === 1 ? 'autor' : 'autores'}
            </span>
          )}
        </div>

        <!-- Categories -->
        {project.categories.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-6">
            {project.categories.map(category => (
              <span class="px-4 py-2 bg-[var(--color-cta)] bg-opacity-10 text-[var(--color-cta)] rounded-full font-medium">
                {category}
              </span>
            ))}
          </div>
        )}

        <!-- Description -->
        {project.description && (
          <p class="text-xl text-gray-700 leading-relaxed max-w-3xl">
            {project.description}
          </p>
        )}
      </header>

      <!-- Cover Image -->
      {project.cover && (
        <div class="mb-12 rounded-lg overflow-hidden shadow-lg">
          <Image
            src={project.cover.url}
            alt={project.title}
            width={project.cover.width || 1200}
            height={project.cover.height || 800}
            class="w-full h-auto"
          />
        </div>
      )}

      <!-- Project Info Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-12 mb-12">
        <!-- Main Content - Images -->
        <div class="lg:col-span-3 space-y-8">
          <!-- Gallery - One image per row, large -->
          {project.gallery.length > 0 && (
            <section>
              <h2 class="text-2xl font-bold mb-6">Galería</h2>
              <div class="space-y-6">
                {project.gallery.map((image, index) => (
                  <button
                    class="gallery-image w-full rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-shadow cursor-zoom-in block"
                    data-image-url={image.url}
                    data-index={index}
                  >
                    <Image
                      src={image.url}
                      alt={image.filename}
                      width={image.width || 1200}
                      height={image.height || 800}
                      class="w-full h-auto"
                    />
                  </button>
                ))}
              </div>
            </section>
          )}

          <!-- Videos -->
          {project.videos.length > 0 && (
            <section>
              <h2 class="text-2xl font-bold mb-6">Videos</h2>
              <div class="space-y-6">
                {project.videos.map(videoUrl => {
                  // Extract video ID for YouTube and Vimeo
                  let embedUrl = videoUrl;

                  if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                    const videoId = videoUrl.includes('youtu.be')
                      ? videoUrl.split('youtu.be/')[1]?.split('?')[0]
                      : new URL(videoUrl).searchParams.get('v');
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                  } else if (videoUrl.includes('vimeo.com')) {
                    const videoId = videoUrl.split('vimeo.com/')[1]?.split('?')[0];
                    embedUrl = `https://player.vimeo.com/video/${videoId}`;
                  }

                  return (
                    <div class="aspect-video rounded-lg overflow-hidden shadow-md">
                      <iframe
                        src={embedUrl}
                        class="w-full h-full"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                      />
                    </div>
                  );
                })}
              </div>
            </section>
          )}
        </div>

        <!-- Sidebar -->
        <aside class="space-y-8">
          <!-- Students -->
          {project.authors.length > 0 && (
            <section class="card p-6">
              <h3 class="text-xl font-bold mb-4">
                {project.authors.length === 1 ? 'Estudiante' : 'Estudiantes'}
              </h3>
              <ul class="space-y-3">
                {project.authors.map(author => (
                  <li>
                    {author.url ? (
                      <a
                        href={author.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-gray-900 underline hover:text-[var(--color-cta)] transition-colors"
                      >
                        {author.fullName}
                      </a>
                    ) : (
                      <span class="text-gray-900">{author.fullName}</span>
                    )}
                  </li>
                ))}
              </ul>
            </section>
          )}

          <!-- Courses -->
          {project.courses.length > 0 && (
            <section class="card p-6">
              <h3 class="text-xl font-bold mb-4">
                {project.courses.length === 1 ? 'Curso' : 'Cursos'}
              </h3>
              <ul class="space-y-2">
                {project.courses.map(course => (
                  <li class="text-gray-700">{course}</li>
                ))}
              </ul>
            </section>
          )}

          <!-- Project ID -->
          {project.numericId && (
            <section class="card p-6">
              <h3 class="text-xl font-bold mb-4">ID del Proyecto</h3>
              <p class="text-gray-900 font-mono text-lg">{project.numericId}</p>
            </section>
          )}

          <!-- Report Problem Link - Hidden -->
          <!--
          <button
            id="report-problem-btn"
            class="text-gray-600 hover:text-[var(--color-cta)] transition-colors text-sm underline"
          >
            Reportar Problema
          </button>
          -->

          <!-- External Link -->
          {project.url && (
            <section class="card p-6 bg-gradient-to-br from-[var(--color-cta)] to-[#095a40] text-white">
              <h3 class="text-xl font-bold mb-4">Ver proyecto</h3>
              <a
                href={project.url}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-4 py-2 bg-white text-[var(--color-cta)] rounded hover:bg-gray-100 transition-colors font-medium"
              >
                Visitar sitio web
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </a>
            </section>
          )}

        </aside>
      </div>

      <!-- Back to Projects -->
      <div class="text-center pt-12 border-t border-gray-200">
        <a href="/muestra" class="btn-cta">
          Volver a la muestra
        </a>
      </div>
    </div>
  </article>

  <Footer slot="footer" />

  <!-- Lightbox Modal -->
  <div id="lightbox" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden items-center justify-center p-4">
    <button id="lightbox-close" class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 z-10">
      &times;
    </button>
    <button id="lightbox-prev" class="absolute left-4 text-white text-4xl hover:text-gray-300 z-10">
      &#8249;
    </button>
    <button id="lightbox-next" class="absolute right-4 text-white text-4xl hover:text-gray-300 z-10">
      &#8250;
    </button>
    <img id="lightbox-image" src="" alt="" class="max-w-full max-h-full object-contain" />
  </div>

  <!-- Report Problem Modal -->
  <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] flex flex-col">
      <!-- Modal Header - Fixed at top -->
      <div class="flex items-center justify-between p-6 pb-4 border-b border-gray-200">
        <h2 class="text-2xl font-bold">Reportar Problema</h2>
        <button id="modal-close" class="text-gray-400 hover:text-gray-600 text-2xl">
          &times;
        </button>
      </div>

      <!-- Modal Content - Scrollable -->
      <div class="flex-1 overflow-y-auto p-6 pt-4">

        <!-- Step 1: Problem Type Selection -->
        <div id="step-problem-type">
          <p class="text-gray-600 mb-4">¿Qué falta en este proyecto?</p>
          <div class="space-y-3">
            <button
              class="problem-type-btn w-full p-4 border-2 border-gray-200 rounded-lg hover:border-[var(--color-cta)] hover:bg-gray-50 transition-all text-left"
              data-type="update-users"
            >
              <div class="font-semibold">Falta estudiantes</div>
              <div class="text-sm text-gray-600">Agregar estudiantes que faltan en el proyecto</div>
            </button>
            <button
              class="problem-type-btn w-full p-4 border-2 border-gray-200 rounded-lg hover:border-[var(--color-cta)] hover:bg-gray-50 transition-all text-left"
              data-type="update-images"
            >
              <div class="font-semibold">Falta imágenes</div>
              <div class="text-sm text-gray-600">Indicar cuántas imágenes faltan</div>
            </button>
            <button
              class="problem-type-btn w-full p-4 border-2 border-gray-200 rounded-lg hover:border-[var(--color-cta)] hover:bg-gray-50 transition-all text-left"
              data-type="update-videos"
            >
              <div class="font-semibold">Falta video</div>
              <div class="text-sm text-gray-600">Indicar cuántos videos faltan</div>
            </button>
          </div>
        </div>

        <!-- Step 2: Student Selection -->
        <div id="step-student-selection" class="hidden">
          <button id="back-to-type" class="text-gray-600 hover:text-[var(--color-cta)] mb-4 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Volver
          </button>

          <p class="text-gray-600 mb-4">Buscar estudiantes que faltan:</p>

          <input
            type="text"
            id="student-search"
            placeholder="Buscar por nombre o código..."
            class="w-full px-4 py-2 border border-gray-300 rounded mb-4 focus:outline-none focus:border-[var(--color-cta)]"
          />

          <div id="student-list" class="space-y-2 max-h-64 overflow-y-auto mb-4">
            <!-- Students will be populated here -->
          </div>

          <div class="flex items-center justify-between pt-4 border-t border-gray-200">
            <span id="selected-count" class="text-sm text-gray-600">0 estudiantes seleccionados</span>
            <button
              id="save-students-btn"
              class="px-6 py-2 bg-[#0F0F0F] text-white rounded hover:bg-black transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed font-medium"
              disabled
            >
              Guardar
            </button>
          </div>
        </div>

        <!-- Step 3: Quantity Selection (Images/Videos) -->
        <div id="step-quantity-selection" class="hidden">
          <button id="back-to-type-quantity" class="text-gray-600 hover:text-[var(--color-cta)] mb-4 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Volver
          </button>

          <p class="text-gray-600 mb-4" id="quantity-label">¿Cuántos faltan?</p>

          <div class="grid grid-cols-3 gap-3 mb-4">
            <button class="quantity-btn px-4 py-3 border-2 border-gray-200 rounded-lg hover:border-[var(--color-cta)] hover:bg-gray-50 transition-all font-semibold" data-quantity="1">1</button>
            <button class="quantity-btn px-4 py-3 border-2 border-gray-200 rounded-lg hover:border-[var(--color-cta)] hover:bg-gray-50 transition-all font-semibold" data-quantity="2">2</button>
            <button class="quantity-btn px-4 py-3 border-2 border-gray-200 rounded-lg hover:border-[var(--color-cta)] hover:bg-gray-50 transition-all font-semibold" data-quantity="3">3</button>
            <button class="quantity-btn px-4 py-3 border-2 border-gray-200 rounded-lg hover:border-[var(--color-cta)] hover:bg-gray-50 transition-all font-semibold" data-quantity="4">4</button>
            <button class="quantity-btn px-4 py-3 border-2 border-gray-200 rounded-lg hover:border-[var(--color-cta)] hover:bg-gray-50 transition-all font-semibold" data-quantity="5">5</button>
            <button class="quantity-btn px-4 py-3 border-2 border-gray-200 rounded-lg hover:border-[var(--color-cta)] hover:bg-gray-50 transition-all font-semibold" data-quantity="TODO">TODO</button>
          </div>

          <div class="flex justify-end pt-4 border-t border-gray-200">
            <button
              id="save-quantity-btn"
              class="px-6 py-2 bg-[#0F0F0F] text-white rounded hover:bg-black transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed font-medium"
              disabled
            >
              Guardar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Lightbox functionality
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
  const lightboxClose = document.getElementById('lightbox-close');
  const lightboxPrev = document.getElementById('lightbox-prev');
  const lightboxNext = document.getElementById('lightbox-next');
  const galleryImages = document.querySelectorAll('.gallery-image');

  let currentIndex = 0;
  const images: string[] = [];

  // Collect all image URLs
  galleryImages.forEach((img) => {
    const url = img.getAttribute('data-image-url');
    if (url) images.push(url);
  });

  function showLightbox(index: number) {
    currentIndex = index;
    lightboxImage.src = images[currentIndex];
    lightbox?.classList.remove('hidden');
    lightbox?.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function hideLightbox() {
    lightbox?.classList.add('hidden');
    lightbox?.classList.remove('flex');
    document.body.style.overflow = 'auto';
  }

  function showNext() {
    currentIndex = (currentIndex + 1) % images.length;
    lightboxImage.src = images[currentIndex];
  }

  function showPrev() {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    lightboxImage.src = images[currentIndex];
  }

  // Event listeners
  galleryImages.forEach((img, index) => {
    img.addEventListener('click', () => showLightbox(index));
  });

  lightboxClose?.addEventListener('click', hideLightbox);
  lightboxPrev?.addEventListener('click', showPrev);
  lightboxNext?.addEventListener('click', showNext);

  // Close on background click
  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) hideLightbox();
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox?.classList.contains('hidden')) {
      if (e.key === 'Escape') hideLightbox();
      if (e.key === 'ArrowRight') showNext();
      if (e.key === 'ArrowLeft') showPrev();
    }
  });

  // Report Problem Modal functionality
  const reportBtn = document.getElementById('report-problem-btn');
  const reportModal = document.getElementById('report-modal');
  const modalClose = document.getElementById('modal-close');

  const stepProblemType = document.getElementById('step-problem-type');
  const stepStudentSelection = document.getElementById('step-student-selection');
  const stepQuantitySelection = document.getElementById('step-quantity-selection');

  const problemTypeBtns = document.querySelectorAll('.problem-type-btn');
  const backToTypeBtn = document.getElementById('back-to-type');
  const backToTypeQuantityBtn = document.getElementById('back-to-type-quantity');

  const studentSearch = document.getElementById('student-search') as HTMLInputElement;
  const studentList = document.getElementById('student-list');
  const selectedCountEl = document.getElementById('selected-count');
  const saveStudentsBtn = document.getElementById('save-students-btn');

  const quantityBtns = document.querySelectorAll('.quantity-btn');
  const saveQuantityBtn = document.getElementById('save-quantity-btn');
  const quantityLabel = document.getElementById('quantity-label');

  let currentProblemType: string = '';
  let selectedStudentIds: Set<string> = new Set();
  let selectedQuantity: string = '';
  let allStudents: any[] = [];

  // Get project ID from page
  const projectId = document.querySelector('[data-project-id]')?.getAttribute('data-project-id') || '';

  // Open modal
  reportBtn?.addEventListener('click', () => {
    reportModal?.classList.remove('hidden');
    reportModal?.classList.add('flex');
    document.body.style.overflow = 'hidden';
    resetModal();
  });

  // Close modal
  function closeModal() {
    reportModal?.classList.add('hidden');
    reportModal?.classList.remove('flex');
    document.body.style.overflow = 'auto';
    resetModal();
  }

  modalClose?.addEventListener('click', closeModal);

  // Close on background click
  reportModal?.addEventListener('click', (e) => {
    if (e.target === reportModal) closeModal();
  });

  // Reset modal to initial state
  function resetModal() {
    showStep('problem-type');
    currentProblemType = '';
    selectedStudentIds.clear();
    selectedQuantity = '';
    updateSelectedCount();
    if (studentSearch) studentSearch.value = '';

    // Reset button states
    saveStudentsBtn?.setAttribute('disabled', 'true');
    saveQuantityBtn?.setAttribute('disabled', 'true');
    if (saveStudentsBtn) saveStudentsBtn.textContent = 'Guardar';
    if (saveQuantityBtn) saveQuantityBtn.textContent = 'Guardar';

    // Remove active states
    quantityBtns.forEach(btn => btn.classList.remove('border-[var(--color-cta)]', 'bg-[var(--color-cta)]', 'text-white'));
  }

  // Show specific step
  function showStep(step: string) {
    stepProblemType?.classList.add('hidden');
    stepStudentSelection?.classList.add('hidden');
    stepQuantitySelection?.classList.add('hidden');

    if (step === 'problem-type') {
      stepProblemType?.classList.remove('hidden');
    } else if (step === 'student-selection') {
      stepStudentSelection?.classList.remove('hidden');
    } else if (step === 'quantity-selection') {
      stepQuantitySelection?.classList.remove('hidden');
    }
  }

  // Handle problem type selection
  problemTypeBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const type = btn.getAttribute('data-type');
      if (!type) return;

      currentProblemType = type;

      if (type === 'update-users') {
        // Load students
        await loadStudents();
        showStep('student-selection');
      } else if (type === 'update-images' || type === 'update-videos') {
        // Show quantity selection
        if (quantityLabel) {
          quantityLabel.textContent = type === 'update-images'
            ? '¿Cuántas imágenes faltan?'
            : '¿Cuántos videos faltan?';
        }
        showStep('quantity-selection');
      }
    });
  });

  // Back buttons
  backToTypeBtn?.addEventListener('click', () => showStep('problem-type'));
  backToTypeQuantityBtn?.addEventListener('click', () => showStep('problem-type'));

  // Load students from API
  async function loadStudents() {
    try {
      const response = await fetch('/api/students');
      allStudents = await response.json();
      renderStudents(allStudents);
    } catch (error) {
      console.error('Error loading students:', error);
      if (studentList) {
        studentList.innerHTML = '<p class="text-red-600">Error al cargar estudiantes</p>';
      }
    }
  }

  // Render students list
  function renderStudents(students: any[]) {
    if (!studentList) return;

    if (students.length === 0) {
      studentList.innerHTML = '<p class="text-gray-500 text-sm">No se encontraron estudiantes</p>';
      return;
    }

    studentList.innerHTML = students.map(student => `
      <label class="flex items-center gap-3 p-3 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer">
        <input
          type="checkbox"
          class="student-checkbox w-4 h-4"
          data-student-id="${student.id}"
          ${selectedStudentIds.has(student.id) ? 'checked' : ''}
        />
        <div class="flex-1">
          <div class="font-medium">${student.fullName}</div>
          ${student.code ? `<div class="text-sm text-gray-500">${student.code}</div>` : ''}
        </div>
      </label>
    `).join('');

    // Add event listeners to checkboxes
    const checkboxes = studentList.querySelectorAll('.student-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', handleStudentSelection);
    });
  }

  // Handle student checkbox change
  function handleStudentSelection(e: Event) {
    const checkbox = e.target as HTMLInputElement;
    const studentId = checkbox.getAttribute('data-student-id');

    if (!studentId) return;

    if (checkbox.checked) {
      selectedStudentIds.add(studentId);
    } else {
      selectedStudentIds.delete(studentId);
    }

    updateSelectedCount();
  }

  // Update selected count and enable/disable save button
  function updateSelectedCount() {
    const count = selectedStudentIds.size;
    if (selectedCountEl) {
      selectedCountEl.textContent = `${count} estudiante${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;
    }

    if (saveStudentsBtn) {
      if (count > 0) {
        saveStudentsBtn.removeAttribute('disabled');
      } else {
        saveStudentsBtn.setAttribute('disabled', 'true');
      }
    }
  }

  // Search students
  studentSearch?.addEventListener('input', (e) => {
    const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();

    const filteredStudents = allStudents.filter(student => {
      const fullName = student.fullName.toLowerCase();
      const code = (student.code || '').toLowerCase();
      return fullName.includes(searchTerm) || code.includes(searchTerm);
    });

    renderStudents(filteredStudents);
  });

  // Handle quantity button selection
  quantityBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const quantity = btn.getAttribute('data-quantity');
      if (!quantity) return;

      selectedQuantity = quantity;

      // Update button states
      quantityBtns.forEach(b => {
        b.classList.remove('border-[var(--color-cta)]', 'bg-[var(--color-cta)]', 'text-white');
        b.classList.add('border-gray-200');
      });

      btn.classList.remove('border-gray-200');
      btn.classList.add('border-[var(--color-cta)]', 'bg-[var(--color-cta)]', 'text-white');

      // Enable save button
      saveQuantityBtn?.removeAttribute('disabled');
    });
  });

  // Save students ticket
  saveStudentsBtn?.addEventListener('click', async () => {
    await saveTicket(currentProblemType, Array.from(selectedStudentIds), selectedStudentIds.size.toString());
  });

  // Save quantity ticket
  saveQuantityBtn?.addEventListener('click', async () => {
    await saveTicket(currentProblemType, [], selectedQuantity);
  });

  // Save ticket to API
  async function saveTicket(type: string, userIds: string[], notes: string) {
    const saveBtn = type === 'update-users' ? saveStudentsBtn : saveQuantityBtn;

    if (!saveBtn) return;

    // Disable button and show loading
    saveBtn.setAttribute('disabled', 'true');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Guardando...';

    try {
      const response = await fetch('/api/tickets', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          type,
          projectId,
          userIds: userIds.length > 0 ? userIds : undefined,
          notes
        })
      });

      if (!response.ok) {
        throw new Error('Error al crear el ticket');
      }

      // Show success
      saveBtn.textContent = '¡Guardado!';

      // Close modal after 1 second
      setTimeout(() => {
        closeModal();
      }, 1000);

    } catch (error) {
      console.error('Error saving ticket:', error);
      saveBtn.textContent = 'Error, intenta de nuevo';
      saveBtn.removeAttribute('disabled');
    }
  }
</script>
